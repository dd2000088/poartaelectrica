<script>
const proxyUrl = "/api/proxy";
let espOnline = false;
let lastMessage = "";  // păstrează ultimul mesaj afișat

// ===================== TRIMITERE COMANDĂ =====================
async function sendCommand(command) {
  if (!espOnline) return;

  try {
    const response = await fetch(`${proxyUrl}?cmd=${command}`);
    const text = await response.text();
    console.log("Răspuns ESP:", text);

    if (command === "ddeesscchhiiddee" || command === "iinncchhiiddee") {
      animateDoors(command);
      updateGateColor(command);
    }
  } catch (err) {
    console.error("Eroare la trimiterea comenzii:", err);
  }
}

// ===================== ANIMARE UȘI =====================
function animateDoors(action) {
  const doorLeft = document.getElementById("door-left");
  const doorRight = document.getElementById("door-right");
  if (!doorLeft || !doorRight) return;

  if (action === "ddeesscchhiiddee") {
    doorLeft.style.transform = "translateX(-100%)";
    doorRight.style.transform = "translateX(100%)";
  } else if (action === "iinncchhiiddee") {
    doorLeft.style.transform = "translateX(0)";
    doorRight.style.transform = "translateX(0)";
  }
}

// ===================== CULOARE PANOU =====================
function updateGateColor(action) {
  const panel = document.getElementById("gate-panel");
  if (!panel) return;

  if (action === "ddeesscchhiiddee") panel.style.backgroundColor = "green";
  else if (action === "iinncchhiiddee") panel.style.backgroundColor = "red";
}

// ===================== VERIFICARE CONEXIUNE ESP =====================
async function checkConnection() {
  const statusEl = document.getElementById("esp-status");
  if (!statusEl) return;

  try {
    const res = await fetch(`${proxyUrl}?cmd=ssttaattuutt`);
    espOnline = res.ok;
    statusEl.className = espOnline ? "connected" : "disconnected";
  } catch {
    espOnline = false;
    statusEl.className = "disconnected";
  }
}

// ===================== MESAJ LIVE =====================
async function getStatusMessages() {
  if (!espOnline) return;

  try {
    const res = await fetch(`${proxyUrl}?cmd=mmeessaajj`);
    const data = await res.json();
    const newMessage = data.messages[0];

    if (!newMessage || newMessage === lastMessage) return;

    lastMessage = newMessage; // salvăm mesajul curent
    const messageList = document.getElementById("message-list");
    messageList.innerHTML = ""; // ȘTERGEM mesajul anterior
    const li = document.createElement("li");
    li.textContent = newMessage;
    messageList.appendChild(li);

  } catch (err) {
    console.error("Eroare la obținerea mesajelor:", err);
  }
}

// ===================== POLLING LIVE =====================
setInterval(() => {
  checkConnection();
  getStatusMessages();
}, 200);
</script>
